#!/bin/bash
# Hook pre-push pour v√©rifier le backend avant d√©ploiement
# Installe ce hook avec: cp scripts/git-hooks/pre-push .git/hooks/ && chmod +x .git/hooks/pre-push

echo "üîç Ex√©cution des v√©rifications pr√©-d√©ploiement..."

# Se positionner dans le r√©pertoire backend
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
BACKEND_DIR="$REPO_ROOT/backend"

# V√©rifier si on pousse vers main
while read local_ref local_sha remote_ref remote_sha
do
    if [[ "$remote_ref" == *"main"* ]] || [[ "$remote_ref" == *"master"* ]]; then
        echo "üì¶ Push vers la branche principale d√©tect√©..."
        
        # Ex√©cuter le script de v√©rification
        if [ -f "$BACKEND_DIR/scripts/pre_deploy_check.py" ]; then
            cd "$BACKEND_DIR"
            python scripts/pre_deploy_check.py
            
            if [ $? -ne 0 ]; then
                echo ""
                echo "‚ùå Les v√©rifications pr√©-d√©ploiement ont √©chou√©!"
                echo "   Corrigez les probl√®mes avant de push vers main."
                echo ""
                echo "   Pour forcer le push (non recommand√©): git push --no-verify"
                exit 1
            fi
        else
            echo "‚ö†Ô∏è  Script pre_deploy_check.py non trouv√©"
        fi
    fi
done

echo "‚úÖ V√©rifications pr√©-d√©ploiement pass√©es!"
exit 0
