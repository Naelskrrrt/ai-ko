#!/bin/bash
# Hook pre-push pour vÃ©rifier le backend ET le frontend avant dÃ©ploiement
# Installe ce hook avec: ./backend/scripts/install-hooks.sh

echo "ğŸ” ExÃ©cution des vÃ©rifications prÃ©-dÃ©ploiement..."

# Se positionner dans le rÃ©pertoire racine du repo
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Si exÃ©cutÃ© depuis .git/hooks, remonter diffÃ©remment
if [[ "$SCRIPT_DIR" == *".git/hooks"* ]]; then
    REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
fi

BACKEND_DIR="$REPO_ROOT/backend"
FRONTEND_DIR="$REPO_ROOT/frontend"

FAILED=0

# VÃ©rifier si on pousse vers main
while read local_ref local_sha remote_ref remote_sha
do
    if [[ "$remote_ref" == *"main"* ]] || [[ "$remote_ref" == *"master"* ]]; then
        echo ""
        echo "ğŸ“¦ Push vers la branche principale dÃ©tectÃ©..."
        echo ""
        
        # === BACKEND ===
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ VÃ‰RIFICATION BACKEND"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if [ -f "$BACKEND_DIR/scripts/pre_deploy_check.py" ]; then
            cd "$BACKEND_DIR"
            python scripts/pre_deploy_check.py
            
            if [ $? -ne 0 ]; then
                echo ""
                echo "âŒ VÃ©rifications BACKEND Ã©chouÃ©es!"
                FAILED=1
            fi
        else
            echo "âš ï¸  Script backend/scripts/pre_deploy_check.py non trouvÃ©"
        fi
        
        echo ""
        
        # === FRONTEND ===
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âš›ï¸  VÃ‰RIFICATION FRONTEND"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if [ -f "$FRONTEND_DIR/scripts/pre_deploy_check.js" ]; then
            cd "$FRONTEND_DIR"
            # Utiliser --skip-build pour un check rapide (le build complet prend trop de temps)
            node scripts/pre_deploy_check.js --skip-build
            
            if [ $? -ne 0 ]; then
                echo ""
                echo "âŒ VÃ©rifications FRONTEND Ã©chouÃ©es!"
                FAILED=1
            fi
        else
            echo "âš ï¸  Script frontend/scripts/pre_deploy_check.js non trouvÃ©"
        fi
        
        # RÃ©sultat final
        if [ $FAILED -ne 0 ]; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ Ã‰CHEC DES VÃ‰RIFICATIONS PRÃ‰-DÃ‰PLOIEMENT"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "   Corrigez les problÃ¨mes avant de push vers main."
            echo ""
            echo "   Pour forcer le push (non recommandÃ©):"
            echo "   git push --no-verify"
            echo ""
            exit 1
        fi
    fi
done

echo ""
echo "âœ… Toutes les vÃ©rifications prÃ©-dÃ©ploiement passÃ©es!"
exit 0
